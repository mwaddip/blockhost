name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      backend:
        description: 'Provisioner backend to build'
        type: string
        default: 'proxmox'
      run_ipv6_test:
        description: 'Run IPv6 login test (requires ADB phone with carrier IPv6)'
        type: boolean
        default: false
      skip_provision:
        description: 'Skip VM provisioning â€” use existing finalized system'
        type: boolean
        default: false

jobs:
  provision:
    name: Provision VM from ISO
    if: ${{ inputs.skip_provision == false }}
    runs-on: [self-hosted, blockhost-${{ inputs.backend || 'proxmox' }}]
    outputs:
      vm_name: ${{ steps.provision.outputs.vm_name }}
      vm_ip: ${{ steps.provision.outputs.vm_ip }}
      nft_contract: ${{ steps.provision.outputs.nft_contract }}
      requests_contract: ${{ steps.provision.outputs.requests_contract }}
    env:
      BACKEND: ${{ inputs.backend || 'proxmox' }}
    steps:
      - uses: actions/checkout@v4
      - name: Init required submodules
        run: |
          git submodule sync
          git submodule update --init blockhost-common blockhost-engine blockhost-broker libpam-web3 facts
          git submodule update --init blockhost-provisioner-${{ env.BACKEND }}

      - name: Symlink base ISO from project directory
        run: |
          mkdir -p build
          if [ ! -f build/debian-12-netinst.iso ]; then
            ln -s /home/mwaddip/projects/blockhost/build/debian-12-netinst.iso build/debian-12-netinst.iso
          fi

      - name: Build ISO (testing mode)
        run: |
          sudo rm -f build/blockhost_0.1.0.iso
          ./scripts/build-packages.sh --backend "$BACKEND"
          sudo ./scripts/build-iso.sh --backend "$BACKEND" --testing

      - name: Provision VM
        id: provision
        env:
          DEPLOYER_KEY: ${{ secrets.DEPLOYER_KEY }}
        run: |
          # Create ramdisk for VM disk image (faster I/O)
          sudo mkdir -p /mnt/ramdisk
          mountpoint -q /mnt/ramdisk || sudo mount -t tmpfs -o size=16G tmpfs /mnt/ramdisk
          ./testing/ci-provision.sh \
            --iso build/blockhost_0.1.0.iso \
            --config testing/ci-config-${BACKEND}.json \
            --name "blockhost-ci-${{ github.run_number }}" \
            --disk-path /mnt/ramdisk

  integration-test:
    name: Integration Test
    needs: [provision]
    if: ${{ always() && (needs.provision.result == 'success' || inputs.skip_provision == true) }}
    runs-on: [self-hosted, blockhost-${{ inputs.backend || 'proxmox' }}]
    env:
      BACKEND: ${{ inputs.backend || 'proxmox' }}
    outputs:
      wallet_key: ${{ steps.test.outputs.wallet_key }}
      vm_ipv6: ${{ steps.test.outputs.vm_ipv6 }}
      vm_name: ${{ steps.test.outputs.vm_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get VM IP
        id: vm
        run: |
          if [ "${{ inputs.skip_provision }}" = "true" ]; then
            # When skipping provision, read IP from the running system
            # The VM should already be finalized and accessible
            VM_IP=$(virsh net-dhcp-leases default 2>/dev/null | \
              grep "blockhost-ci" | awk '{print $5}' | cut -d'/' -f1 | tail -1)
            if [ -z "$VM_IP" ]; then
              echo "No blockhost-ci VM found in DHCP leases. Provide VM_IP manually."
              exit 1
            fi
            echo "vm_ip=$VM_IP" >> "$GITHUB_OUTPUT"
          else
            echo "vm_ip=${{ needs.provision.outputs.vm_ip }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Copy test script to VM
        env:
          VM_IP: ${{ steps.vm.outputs.vm_ip }}
        run: |
          sshpass -p blockhost scp \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            testing/integration-test-${BACKEND}.sh \
            "root@${VM_IP}:/tmp/integration-test.sh"

      - name: Run integration test
        id: test
        env:
          VM_IP: ${{ steps.vm.outputs.vm_ip }}
        run: |
          SSH_CMD="sshpass -p blockhost ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          OUTPUT=$($SSH_CMD "root@${VM_IP}" \
            "chmod +x /tmp/integration-test.sh && sudo -u blockhost /tmp/integration-test.sh --cleanup") || {
            EXIT_CODE=$?
            echo "$OUTPUT"
            echo "--- Integration test failed (exit $EXIT_CODE), fetching monitor logs ---"
            $SSH_CMD "root@${VM_IP}" "journalctl -u blockhost-monitor --no-pager -n 100" || true
            exit $EXIT_CODE
          }
          echo "$OUTPUT"
          # Extract wallet key from output (last non-empty line after "Test wallet private key")
          WALLET_KEY=$(echo "$OUTPUT" | grep -A1 "Test wallet private key" | tail -1 | tr -d '[:space:]')
          VM_IPV6=$(echo "$OUTPUT" | grep -A1 "VM IPv6 address" | tail -1 | tr -d '[:space:]')
          VM_NAME=$(echo "$OUTPUT" | grep -A1 "VM name" | tail -1 | tr -d '[:space:]')
          echo "wallet_key=$WALLET_KEY" >> "$GITHUB_OUTPUT"
          echo "vm_ipv6=$VM_IPV6" >> "$GITHUB_OUTPUT"
          echo "vm_name=$VM_NAME" >> "$GITHUB_OUTPUT"

  ipv6-login-test:
    name: IPv6 Login Test
    needs: [integration-test]
    if: ${{ inputs.run_ipv6_test == true && needs.integration-test.result == 'success' }}
    runs-on: [self-hosted, blockhost-phone]
    steps:
      - uses: actions/checkout@v4

      - name: Run IPv6 login test
        env:
          WALLET_KEY: ${{ needs.integration-test.outputs.wallet_key }}
          VM_IPV6: ${{ needs.integration-test.outputs.vm_ipv6 }}
          VM_NAME: ${{ needs.integration-test.outputs.vm_name }}
        run: |
          ./testing/ipv6-login-test.sh \
            --private-key "$WALLET_KEY" \
            --ipv6 "$VM_IPV6" \
            --vm-name "$VM_NAME"

  cleanup:
    name: Cleanup
    needs: [provision, integration-test, ipv6-login-test]
    if: ${{ always() && inputs.skip_provision == false && needs.provision.outputs.vm_name != '' }}
    runs-on: [self-hosted, blockhost-${{ inputs.backend || 'proxmox' }}]
    steps:
      - uses: actions/checkout@v4

      - name: Release IPv6 tunnel lease
        if: ${{ needs.provision.outputs.nft_contract != '' && needs.provision.outputs.requests_contract != '' }}
        env:
          BROKER_OPERATOR_KEY: ${{ secrets.BROKER_OPERATOR_KEY }}
          NFT_CONTRACT: ${{ needs.provision.outputs.nft_contract }}
          REQUESTS_CONTRACT: ${{ needs.provision.outputs.requests_contract }}
          RPC_URL: https://ethereum-sepolia-rpc.publicnode.com
        run: |
          echo "Releasing IPv6 tunnel allocation for NFT contract: $NFT_CONTRACT"
          echo "Requests contract: $REQUESTS_CONTRACT"
          cast send "$REQUESTS_CONTRACT" \
            "releaseAllocation(address)" \
            "$NFT_CONTRACT" \
            --rpc-url "$RPC_URL" \
            --private-key "$BROKER_OPERATOR_KEY" \
            --json > /dev/null
          echo "IPv6 tunnel lease released"

      - name: Destroy VM
        run: |
          ./testing/ci-provision.sh --destroy "${{ needs.provision.outputs.vm_name }}"
