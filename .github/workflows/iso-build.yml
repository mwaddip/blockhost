name: ISO Build

on:
  workflow_dispatch:
    inputs:
      backend:
        description: 'Provisioner backend to build'
        type: string
        default: 'proxmox'
      testing_mode:
        description: 'Build with --testing flag (SSH root login, apt proxy, testing marker)'
        type: boolean
        default: true
  push:
    tags:
      - 'v*'

jobs:
  build-iso:
    name: Build BlockHost ISO
    runs-on: [self-hosted, blockhost-iso]
    env:
      BACKEND: ${{ inputs.backend || 'proxmox' }}
    steps:
      - uses: actions/checkout@v4
      - name: Init required submodules
        run: |
          git submodule update --init blockhost-common blockhost-engine blockhost-broker libpam-web3 facts
          git submodule update --init blockhost-provisioner-${{ env.BACKEND }}

      - name: Symlink base ISO from project directory
        run: |
          mkdir -p build
          if [ ! -f build/debian-12-netinst.iso ]; then
            ln -s /home/mwaddip/projects/blockhost/build/debian-12-netinst.iso build/debian-12-netinst.iso
          fi
          if [ ! -f build/debian-12-netinst.iso ]; then
            echo "Base Debian 12 netinst ISO not found"
            echo "Download it to: /home/mwaddip/projects/blockhost/build/"
            echo "https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/"
            exit 1
          fi

      - name: Build packages
        run: ./scripts/build-packages.sh --backend "$BACKEND"

      - name: Verify packages
        run: ./scripts/ci-verify-packages.sh --backend "$BACKEND"

      - name: Remove old ISO
        run: sudo rm -f build/blockhost_*.iso

      - name: Build ISO
        run: |
          ARGS="--backend $BACKEND"
          # workflow_dispatch: use input; tag push: always enable testing
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.testing_mode }}" = "true" ]; then
              ARGS="$ARGS --testing --apt-proxy http://192.168.122.1:3142"
            fi
          fi
          sudo ./scripts/build-iso.sh $ARGS

      - name: Upload ISO artifact
        if: ${{ github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: blockhost-iso
          path: build/blockhost_*.iso
          retention-days: 30
