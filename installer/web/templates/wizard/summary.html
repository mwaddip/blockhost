{% extends "base.html" %}
{% from "macros/wizard_steps.html" import step_bar %}

{% block title %}Summary - BlockHost Installer{% endblock %}

{% block content %}
{{ step_bar('summary') }}

<div class="card" id="summary-card">
    <h2>Configuration Summary</h2>
    <p class="text-muted mb-2">Review your configuration before finalizing setup.</p>

    <!-- Network Summary -->
    <div class="summary-section">
        <h3>Network</h3>
        <div class="summary-item">
            <span class="summary-label">IP Address</span>
            <span class="summary-value">{{ summary.network.ip or 'Not configured' }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Gateway</span>
            <span class="summary-value">{{ summary.network.gateway or 'N/A' }}</span>
        </div>
    </div>

    <!-- Engine Summary (dynamic — loaded from engine plugin or fallback) -->
    {% if engine_summary_template %}
        {% include engine_summary_template %}
    {% elif engine_summary %}
    <div class="summary-section">
        <h3>Blockchain</h3>
        {% for key, value in engine_summary.items() %}
        <div class="summary-item">
            <span class="summary-label">{{ key | replace('_', ' ') | title }}</span>
            <span class="summary-value">{{ value }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Provisioner Summary (dynamic — loaded from provisioner plugin or fallback) -->
    {% if provisioner_summary_template %}
        {% include provisioner_summary_template %}
    {% elif provisioner_summary %}
    <div class="summary-section">
        <h3>Provisioner</h3>
        {% for key, value in provisioner_summary.items() %}
        <div class="summary-item">
            <span class="summary-label">{{ key | replace('_', ' ') | title }}</span>
            <span class="summary-value">{{ value }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- IPv6 Summary -->
    <div class="summary-section">
        <h3>IPv6</h3>
        <div class="summary-item">
            <span class="summary-label">Source</span>
            <span class="summary-value">{{ 'Broker Network' if summary.ipv6.mode == 'broker' else 'Manual' }}</span>
        </div>
        {% if summary.ipv6.mode == 'broker' %}
        <div class="summary-item">
            <span class="summary-label">Broker Registry</span>
            <span class="summary-value" style="font-size: 0.75rem;">{{ summary.ipv6.broker_registry or 'Will be fetched' }}</span>
        </div>
        {% else %}
        <div class="summary-item">
            <span class="summary-label">Prefix</span>
            <span class="summary-value">{{ summary.ipv6.prefix }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Admin Summary -->
    <div class="summary-section">
        <h3>Admin Commands</h3>
        <div class="summary-item">
            <span class="summary-label">Admin Wallet</span>
            <span class="summary-value" style="font-size: 0.75rem;">{{ summary.admin.wallet }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Admin Commands</span>
            <span class="summary-value">{{ 'Enabled' if summary.admin.enabled else 'Disabled' }}</span>
        </div>
        {% if summary.admin.enabled %}
        <div class="summary-item">
            <span class="summary-label">Destination Mode</span>
            <span class="summary-value">{{ summary.admin.destination_mode }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Commands Configured</span>
            <span class="summary-value">{{ summary.admin.command_count }}</span>
        </div>
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('wizard_summary') }}" id="summary-form">
        <div class="flex justify-between" style="margin-top: 2rem;">
            <a href="{{ url_for('wizard_admin_commands') }}" class="btn btn-secondary">Back</a>
            <div>
                <button type="submit" name="confirm" value="no" class="btn btn-secondary">Cancel</button>
                <button type="submit" name="confirm" value="yes" class="btn btn-primary" id="finalize-btn">
                    Finalize Setup
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Progress Card (shown during finalization) -->
<div class="card hidden" id="progress-card" style="max-width: 700px; margin: 0 auto;">
    <h2>Finalizing Setup</h2>
    <p class="text-muted mb-2">Please wait while BlockHost is configured. This may take several minutes.</p>

    <div style="margin: 2rem 0;">
        <div id="progress-bar" style="background: var(--bg-input); border-radius: 0.5rem; height: 1.5rem; overflow: hidden;">
            <div id="progress-fill" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.5s;"></div>
        </div>
        <div id="progress-text" class="mt-1 text-center">0%</div>
    </div>

    <ul class="progress-list" id="progress-steps">
        {% for step in all_finalization_steps %}
        <li id="step-{{ step.id }}" data-step="{{ step.id }}">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">{{ step.label }}</span>
                <span class="step-status"></span>
                {% if step.hint %}
                <span class="step-hint">{{ step.hint }}</span>
                {% endif %}
                <div id="step-{{ step.id }}-data" class="step-data hidden"></div>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('{{ step.id }}')">Retry</button>
        </li>
        {% endfor %}
    </ul>

    <!-- Validation Output (testing mode only) -->
    <div id="validation-output-section" class="hidden" style="margin-top: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem;">Validation Results</h3>
        <pre id="validation-output" style="background: var(--bg-input); padding: 1rem; border-radius: 0.5rem; font-size: 0.75rem; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
    </div>

    <div id="completion-section" class="hidden" style="margin-top: 2rem;">
        <div class="alert alert-success">
            <strong>Setup Complete!</strong> BlockHost has been configured successfully.
        </div>
        <p class="text-muted" style="margin-top: 1rem;">
            The system is now operational. VMs will be provisioned automatically when users purchase subscriptions.
        </p>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button onclick="reboot()" class="btn btn-primary">Reboot System</button>
            <a href="/api/finalize/config" class="btn btn-secondary" download>Download Encrypted Config</a>
        </div>
    </div>

    <div id="error-section" class="hidden" style="margin-top: 2rem;">
        <div class="alert alert-error">
            <strong>Step failed:</strong> <span id="error-step-name"></span>
            <p id="error-message" style="margin-top: 0.5rem; font-family: monospace; font-size: 0.85rem;"></p>
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="retryFailed()">Retry Failed Step</button>
            <button class="btn btn-secondary" onclick="resetAndRestart()">Start Over</button>
        </div>
    </div>

    <div id="resume-section" class="hidden" style="margin-top: 2rem;">
        <div class="alert alert-info">
            <strong>Previous setup incomplete.</strong> You can resume from where you left off.
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="resumeSetup()">Resume Setup</button>
            <button class="btn btn-secondary" onclick="resetAndRestart()">Start Over</button>
        </div>
    </div>
</div>

<!-- Completion Card -->
<div class="card hidden" id="completion-card" style="max-width: 600px; margin: 0 auto; text-align: center;">
    <h2 class="text-success">Setup Complete!</h2>
    <p class="text-muted mb-2">BlockHost has been configured successfully.</p>

    <div class="alert alert-success" style="margin: 2rem 0;">
        <strong>Important:</strong> The system is now operational. VMs will be provisioned automatically
        when users purchase subscriptions.
    </div>

    <div class="summary-section" style="text-align: left;">
        <h3>What's Next?</h3>
        <ul style="list-style: disc; padding-left: 1.5rem; color: var(--text-muted);">
            {% if prov_ui.management_url %}
            <li>Access management at <a href="{{ prov_ui.management_url }}">{{ prov_ui.management_url }}</a></li>
            {% endif %}
            <li>The engine is monitoring for new subscriptions</li>
            <li>VMs will be created automatically when orders are placed</li>
            <li>Users connect to their VMs using token-based authentication</li>
        </ul>
    </div>

    <div style="margin-top: 2rem;">
        <button onclick="reboot()" class="btn btn-primary">Reboot System</button>
        {% if prov_ui.management_url %}
        <a href="{{ prov_ui.management_url }}" class="btn btn-secondary" style="margin-left: 0.5rem;">
            {{ prov_ui.management_label | default('Open Management') }}
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.progress-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.progress-list li {
    display: flex;
    align-items: flex-start;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
    gap: 0.75rem;
}

.progress-list li:last-child {
    border-bottom: none;
}

.step-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1rem;
}

.step-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.step-name {
    font-weight: 500;
}

.step-status {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.step-hint {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-style: italic;
}

.step-data {
    margin-top: 0.5rem;
}

.progress-list li.completed .step-icon {
    color: var(--success);
}

.progress-list li.in-progress .step-icon {
    color: var(--primary);
}

.progress-list li.failed .step-icon {
    color: var(--danger);
}

.progress-list li.failed .step-status {
    color: var(--danger);
}

.btn-retry {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background: var(--warning);
    border-color: var(--warning);
}

.btn-retry:hover {
    background: #d97706;
}

.spinner-small {
    width: 16px;
    height: 16px;
    border: 2px solid var(--primary);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Contract address display */
.contract-addr-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.25rem;
}

.contract-addr-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    min-width: 5rem;
}

.contract-addr {
    font-size: 0.7rem;
    background: var(--bg-input);
    padding: 0.15rem 0.4rem;
    border-radius: 0.25rem;
    user-select: all;
}

.btn-copy {
    background: none;
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    padding: 0.1rem 0.35rem;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--text-muted);
    line-height: 1;
}

.btn-copy:hover {
    background: var(--bg-input);
    color: var(--text-primary);
}

.btn-copy.copied {
    color: var(--success);
    border-color: var(--success);
}

/* Validation output styling */
#validation-output {
    line-height: 1.4;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let pollInterval;
// Step metadata from backend (dynamic — includes engine + provisioner + installer steps)
const allSteps = {{ all_finalization_steps | tojson }};
const stepOrder = allSteps.map(s => s.id);
const stepNames = {};
allSteps.forEach(s => { stepNames[s.id] = s.label; });

// Check for existing state on page load
document.addEventListener('DOMContentLoaded', function() {
    checkExistingState();
});

function checkExistingState() {
    fetch('/api/finalize/status')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'completed') {
            // Already complete, show progress card with completion
            showProgressCard();
            updateProgress(data);
            showCompletion();
        } else if (data.status === 'running') {
            // Currently running, show progress and poll
            showProgressCard();
            updateProgress(data);
            startPolling();
        } else if (data.status === 'failed') {
            // Failed, show progress with error
            showProgressCard();
            updateProgress(data);
            showError(data.failed_step, data.error);
        } else if (data.completed_steps && data.completed_steps.length > 0) {
            // Partially complete, offer to resume
            showProgressCard();
            updateProgress(data);
            document.getElementById('resume-section').classList.remove('hidden');
        }
        // Otherwise, show summary card (default)
    })
    .catch(error => {
        console.error('Error checking state:', error);
        // Show summary card on error
    });
}

// Handle form submission
document.getElementById('summary-form').addEventListener('submit', function(e) {
    if (e.submitter.value !== 'yes') return;

    e.preventDefault();
    startFinalization();
});

function showProgressCard() {
    document.getElementById('summary-card').classList.add('hidden');
    document.getElementById('progress-card').classList.remove('hidden');
}

function startFinalization() {
    showProgressCard();

    // Start the finalization process
    fetch('/api/finalize', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running' || data.status === 'completed') {
            startPolling();
        } else if (data.error) {
            showError(null, data.error);
        }
    })
    .catch(error => {
        showError(null, error.message);
    });
}

function resumeSetup() {
    document.getElementById('resume-section').classList.add('hidden');
    document.getElementById('error-section').classList.add('hidden');

    fetch('/api/finalize/retry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running') {
            startPolling();
        } else if (data.error) {
            showError(null, data.error);
        }
    })
    .catch(error => {
        showError(null, error.message);
    });
}

function retryStep(stepId) {
    document.getElementById('error-section').classList.add('hidden');

    // Reset step UI
    const li = document.getElementById('step-' + stepId);
    li.classList.remove('failed');
    li.querySelector('.step-status').textContent = '';
    li.querySelector('.btn-retry').classList.add('hidden');

    fetch('/api/finalize/retry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({step_id: stepId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running') {
            startPolling();
        } else if (data.error) {
            showError(stepId, data.error);
        }
    })
    .catch(error => {
        showError(stepId, error.message);
    });
}

function retryFailed() {
    document.getElementById('error-section').classList.add('hidden');

    fetch('/api/finalize/retry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running') {
            startPolling();
        } else if (data.error) {
            showError(null, data.error);
        }
    })
    .catch(error => {
        showError(null, error.message);
    });
}

function resetAndRestart() {
    if (!confirm('This will reset all progress and start the configuration from the beginning. Continue?')) {
        return;
    }

    fetch('/api/finalize/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        // Reset UI
        stepOrder.forEach(step => {
            const li = document.getElementById('step-' + step);
            if (!li) return;
            li.classList.remove('completed', 'in-progress', 'failed');
            li.querySelector('.step-icon').innerHTML = '&#9675;';
            li.querySelector('.step-status').textContent = '';
            li.querySelector('.btn-retry').classList.add('hidden');
            // Clear step data
            const dataDiv = document.getElementById('step-' + step + '-data');
            if (dataDiv) {
                dataDiv.innerHTML = '';
                dataDiv.classList.add('hidden');
            }
        });

        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('progress-text').textContent = '0%';
        document.getElementById('error-section').classList.add('hidden');
        document.getElementById('resume-section').classList.add('hidden');

        // Start fresh
        startFinalization();
    })
    .catch(error => {
        alert('Error resetting state: ' + error.message);
    });
}

function startPolling() {
    stopPolling();
    pollInterval = setInterval(pollStatus, 2000);
    pollStatus(); // Immediate first poll
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

function pollStatus() {
    fetch('/api/finalize/status')
    .then(response => response.json())
    .then(data => {
        updateProgress(data);

        if (data.status === 'completed') {
            stopPolling();
            showCompletion();
        } else if (data.status === 'failed') {
            stopPolling();
            showError(data.failed_step, data.error);
        }
    })
    .catch(error => {
        console.error('Poll error:', error);
        // Don't stop polling on transient errors
    });
}

function formatLabel(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
}

function renderStepData(stepId, container, data) {
    container.innerHTML = '';
    for (const key of Object.keys(data)) {
        const value = data[key];
        if (value === null || value === undefined) continue;

        // Render 'message' as muted text
        if (key === 'message') {
            const msg = document.createElement('div');
            msg.style.cssText = 'font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem;';
            msg.textContent = value;
            container.appendChild(msg);
            continue;
        }

        // Handle nested objects (one level deep)
        if (typeof value === 'object' && !Array.isArray(value)) {
            for (const subKey of Object.keys(value)) {
                const subValue = value[subKey];
                if (subValue === null || subValue === undefined) continue;
                appendDataRow(container, stepId + '-' + subKey, subKey, String(subValue));
            }
            continue;
        }

        appendDataRow(container, stepId + '-' + key, key, String(value));
    }
}

function appendDataRow(container, id, key, value) {
    const row = document.createElement('div');
    row.className = 'contract-addr-row';

    const label = document.createElement('span');
    label.className = 'contract-addr-label';
    label.textContent = formatLabel(key) + ':';

    const code = document.createElement('code');
    code.className = 'contract-addr';
    code.id = 'step-data-' + id.replace(/[^a-z0-9_-]/gi, '-');
    code.textContent = value;

    row.appendChild(label);
    row.appendChild(code);

    // Add copy button for address-like or long values
    if (value.startsWith('0x') || value.includes(':') || value.length > 20) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-copy';
        btn.title = 'Copy';
        btn.innerHTML = '&#128203;';
        btn.onclick = function() { copyAddress(code.id); };
        row.appendChild(btn);
    }

    container.appendChild(row);
}

function updateProgress(data) {
    // Update progress bar
    const percent = data.progress || 0;
    document.getElementById('progress-fill').style.width = percent + '%';
    document.getElementById('progress-text').textContent = percent + '%';

    // Update step indicators
    const currentStep = data.current_step;
    const completedSteps = data.completed_steps || [];
    const steps = data.steps || {};

    stepOrder.forEach(function(stepId) {
        const li = document.getElementById('step-' + stepId);
        if (!li) return;
        const icon = li.querySelector('.step-icon');
        const status = li.querySelector('.step-status');
        const retryBtn = li.querySelector('.btn-retry');
        const stepData = steps[stepId] || {};

        // Reset classes
        li.classList.remove('completed', 'in-progress', 'failed');
        if (retryBtn) retryBtn.classList.add('hidden');

        if (stepData.status === 'completed' || completedSteps.includes(stepId)) {
            li.classList.add('completed');
            icon.innerHTML = '&#10003;';
            status.textContent = stepData.completed_at ? 'Completed' : '';

            // Render step data generically
            if (stepData.data) {
                const dataDiv = document.getElementById('step-' + stepId + '-data');
                if (dataDiv && dataDiv.children.length === 0) {
                    renderStepData(stepId, dataDiv, stepData.data);
                    dataDiv.classList.remove('hidden');
                }
            }
        } else if (stepData.status === 'in_progress' || stepId === currentStep) {
            li.classList.add('in-progress');
            icon.innerHTML = '<div class="spinner-small"></div>';
            status.textContent = 'Running...';
        } else if (stepData.status === 'failed') {
            li.classList.add('failed');
            icon.innerHTML = '&#10007;';
            status.textContent = stepData.error || 'Failed';
            retryBtn.classList.remove('hidden');
            // Broker allocation has a 2-minute cooldown between requests
            if (stepId === 'ipv6' && stepData.error && stepData.error.includes('roker')) {
                const hint = document.createElement('div');
                hint.style.cssText = 'font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;';
                hint.textContent = 'Broker requests expire after 2 minutes. Wait before retrying.';
                status.parentNode.appendChild(hint);
                retryBtn.disabled = true;
                retryBtn.textContent = 'Wait 2m...';
                var remaining = 120;
                var countdown = setInterval(function() {
                    remaining--;
                    if (remaining <= 0) {
                        clearInterval(countdown);
                        retryBtn.disabled = false;
                        retryBtn.textContent = 'Retry';
                    } else {
                        retryBtn.textContent = 'Wait ' + Math.floor(remaining/60) + ':' + String(remaining%60).padStart(2,'0');
                    }
                }, 1000);
            }
        } else {
            icon.innerHTML = '&#9675;';
            status.textContent = '';
        }
    });
}

function showCompletion() {
    stopPolling();
    // Keep progress card visible, show completion section within it
    document.getElementById('completion-section').classList.remove('hidden');
    // Hide the progress bar since we're done
    document.getElementById('progress-bar').parentElement.style.display = 'none';
    document.getElementById('progress-text').style.display = 'none';
    // Update title
    document.querySelector('#progress-card h2').textContent = 'Setup Complete';
    document.querySelector('#progress-card p.text-muted').textContent = 'All steps completed successfully.';

    // Mark setup complete (redundant but ensures marker exists)
    fetch('/api/complete', {method: 'POST'});

    // Fetch and display validation output (testing mode only)
    fetchValidationOutput();
}

function fetchValidationOutput() {
    fetch('/api/validation-output')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.output) {
            var section = document.getElementById('validation-output-section');
            var pre = document.getElementById('validation-output');
            pre.textContent = data.output;
            section.classList.remove('hidden');
        }
    })
    .catch(function(error) {
        console.error('Error fetching validation output:', error);
    });
}

function showError(stepId, message) {
    var errorSection = document.getElementById('error-section');
    var errorStepName = document.getElementById('error-step-name');
    var errorMessage = document.getElementById('error-message');

    errorSection.classList.remove('hidden');
    errorStepName.textContent = stepId ? stepNames[stepId] : 'Unknown step';
    errorMessage.textContent = message || 'Unknown error occurred';

    // Show retry button on the failed step
    if (stepId) {
        var li = document.getElementById('step-' + stepId);
        if (li) {
            li.querySelector('.btn-retry').classList.remove('hidden');
        }
    }

    // If validation failed, show the detailed output
    if (stepId === 'validate') {
        fetchValidationOutput();
    }
}

function copyAddress(elementId) {
    var text = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(text).then(function() {
        var btn = document.getElementById(elementId).nextElementSibling;
        btn.classList.add('copied');
        btn.innerHTML = '&#10003;';
        setTimeout(function() {
            btn.classList.remove('copied');
            btn.innerHTML = '&#128203;';
        }, 2000);
    }).catch(function() {
        // Fallback for Firefox on HTTP (clipboard API requires secure context)
        var range = document.createRange();
        range.selectNodeContents(document.getElementById(elementId));
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        try {
            document.execCommand('copy');
            var btn = document.getElementById(elementId).nextElementSibling;
            btn.classList.add('copied');
            btn.innerHTML = '&#10003;';
            setTimeout(function() {
                btn.classList.remove('copied');
                btn.innerHTML = '&#128203;';
            }, 2000);
        } catch(e) {
            // At least the text is selected for manual copy
        }
        sel.removeAllRanges();
    });
}

function reboot() {
    if (!confirm('Setup is complete. The system will reboot now. After reboot the system is ready to accept orders.')) {
        return;
    }

    fetch('/api/reboot', {method: 'POST'})
    .catch(function(error) {
        alert('Reboot failed: ' + error.message);
    });
}
</script>
{% endblock %}
