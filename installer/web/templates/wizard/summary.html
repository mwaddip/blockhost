{% extends "base.html" %}

{% block title %}Summary - BlockHost Installer{% endblock %}

{% block content %}
<!-- Progress Steps -->
<div class="steps">
    <div class="step completed">
        <span class="step-number">&#10003;</span>
        <span>Network</span>
    </div>
    <div class="step-connector completed"></div>
    <div class="step completed">
        <span class="step-number">&#10003;</span>
        <span>Storage</span>
    </div>
    <div class="step-connector completed"></div>
    <div class="step completed">
        <span class="step-number">&#10003;</span>
        <span>Blockchain</span>
    </div>
    <div class="step-connector completed"></div>
    <div class="step completed">
        <span class="step-number">&#10003;</span>
        <span>Proxmox</span>
    </div>
    <div class="step-connector completed"></div>
    <div class="step completed">
        <span class="step-number">&#10003;</span>
        <span>IPv6</span>
    </div>
    <div class="step-connector completed"></div>
    <div class="step completed">
        <span class="step-number">&#10003;</span>
        <span>Admin</span>
    </div>
    <div class="step-connector completed"></div>
    <div class="step active">
        <span class="step-number">7</span>
        <span>Summary</span>
    </div>
</div>

<div class="card" id="summary-card">
    <h2>Configuration Summary</h2>
    <p class="text-muted mb-2">Review your configuration before finalizing setup.</p>

    <!-- Network Summary -->
    <div class="summary-section">
        <h3>Network</h3>
        <div class="summary-item">
            <span class="summary-label">IP Address</span>
            <span class="summary-value">{{ summary.network.ip or 'Not configured' }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Gateway</span>
            <span class="summary-value">{{ summary.network.gateway or 'N/A' }}</span>
        </div>
    </div>

    <!-- Blockchain Summary -->
    <div class="summary-section">
        <h3>Blockchain</h3>
        <div class="summary-item">
            <span class="summary-label">Network</span>
            <span class="summary-value">{{ summary.blockchain.network_name }} (Chain ID: {{ summary.blockchain.chain_id }})</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">RPC Endpoint</span>
            <span class="summary-value" style="font-size: 0.75rem;">{{ summary.blockchain.rpc_url | truncate(50) }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Deployer Address</span>
            <span class="summary-value" style="font-size: 0.75rem;">{{ summary.blockchain.deployer_address }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Contracts</span>
            <span class="summary-value">{{ 'Deploy new' if summary.blockchain.deploy_contracts else 'Use existing' }}</span>
        </div>
        {% if not summary.blockchain.deploy_contracts %}
        <div class="summary-item">
            <span class="summary-label">NFT Contract</span>
            <span class="summary-value" style="font-size: 0.75rem;">{{ summary.blockchain.nft_contract }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Subscriptions</span>
            <span class="summary-value" style="font-size: 0.75rem;">{{ summary.blockchain.subscription_contract }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Proxmox Summary -->
    <div class="summary-section">
        <h3>Proxmox</h3>
        <div class="summary-item">
            <span class="summary-label">Node</span>
            <span class="summary-value">{{ summary.proxmox.node }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Storage</span>
            <span class="summary-value">{{ summary.proxmox.storage }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Network Bridge</span>
            <span class="summary-value">{{ summary.proxmox.bridge }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">VMID Range</span>
            <span class="summary-value">{{ summary.proxmox.vmid_start }} - {{ summary.proxmox.vmid_end }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">IP Pool</span>
            <span class="summary-value">{{ summary.proxmox.ip_start }} - {{ summary.proxmox.ip_end }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Expiry Grace Period</span>
            <span class="summary-value">{{ summary.proxmox.gc_grace_days }} days</span>
        </div>
    </div>

    <!-- IPv6 Summary -->
    <div class="summary-section">
        <h3>IPv6</h3>
        <div class="summary-item">
            <span class="summary-label">Source</span>
            <span class="summary-value">{{ 'Broker Network' if summary.ipv6.mode == 'broker' else 'Manual' }}</span>
        </div>
        {% if summary.ipv6.mode == 'broker' %}
        <div class="summary-item">
            <span class="summary-label">Broker Registry</span>
            <span class="summary-value" style="font-size: 0.75rem;">{{ summary.ipv6.broker_registry or 'Will be fetched' }}</span>
        </div>
        {% else %}
        <div class="summary-item">
            <span class="summary-label">Prefix</span>
            <span class="summary-value">{{ summary.ipv6.prefix }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Admin Summary -->
    <div class="summary-section">
        <h3>Admin Commands</h3>
        <div class="summary-item">
            <span class="summary-label">Admin Wallet</span>
            <span class="summary-value" style="font-size: 0.75rem;">{{ summary.admin.wallet }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Admin Commands</span>
            <span class="summary-value">{{ 'Enabled' if summary.admin.enabled else 'Disabled' }}</span>
        </div>
        {% if summary.admin.enabled %}
        <div class="summary-item">
            <span class="summary-label">Destination Mode</span>
            <span class="summary-value">{{ summary.admin.destination_mode }}</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Commands Configured</span>
            <span class="summary-value">{{ summary.admin.command_count }}</span>
        </div>
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('wizard_summary') }}" id="summary-form">
        <div class="flex justify-between" style="margin-top: 2rem;">
            <a href="{{ url_for('wizard_admin_commands') }}" class="btn btn-secondary">Back</a>
            <div>
                <button type="submit" name="confirm" value="no" class="btn btn-secondary">Cancel</button>
                <button type="submit" name="confirm" value="yes" class="btn btn-primary" id="finalize-btn">
                    Finalize Setup
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Progress Card (shown during finalization) -->
<div class="card hidden" id="progress-card" style="max-width: 700px; margin: 0 auto;">
    <h2>Finalizing Setup</h2>
    <p class="text-muted mb-2">Please wait while BlockHost is configured. This may take several minutes.</p>

    <div style="margin: 2rem 0;">
        <div id="progress-bar" style="background: var(--bg-input); border-radius: 0.5rem; height: 1.5rem; overflow: hidden;">
            <div id="progress-fill" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.5s;"></div>
        </div>
        <div id="progress-text" class="mt-1 text-center">0%</div>
    </div>

    <ul class="progress-list" id="progress-steps">
        <li id="step-keypair" data-step="keypair">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Generate server keypair</span>
                <span class="step-status"></span>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('keypair')">Retry</button>
        </li>
        <li id="step-wallet" data-step="wallet">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Configure deployer wallet</span>
                <span class="step-status"></span>
                <div id="wallet-data" class="hidden" style="margin-top: 0.5rem;">
                    <div class="contract-addr-row">
                        <span class="contract-addr-label">Deployer:</span>
                        <code id="wallet-deployer-addr" class="contract-addr"></code>
                        <button type="button" class="btn-copy" onclick="copyAddress('wallet-deployer-addr')" title="Copy">&#128203;</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('wallet')">Retry</button>
        </li>
        <li id="step-contracts" data-step="contracts">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name" id="step-contracts-text">Deploy smart contracts</span>
                <span class="step-status"></span>
                <div id="contract-addresses" class="hidden" style="margin-top: 0.5rem;">
                    <div class="contract-addr-row">
                        <span class="contract-addr-label">NFT:</span>
                        <code id="contract-nft-addr" class="contract-addr"></code>
                        <button type="button" class="btn-copy" onclick="copyAddress('contract-nft-addr')" title="Copy">&#128203;</button>
                    </div>
                    <div class="contract-addr-row">
                        <span class="contract-addr-label">Subscriptions:</span>
                        <code id="contract-sub-addr" class="contract-addr"></code>
                        <button type="button" class="btn-copy" onclick="copyAddress('contract-sub-addr')" title="Copy">&#128203;</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('contracts')">Retry</button>
        </li>
        <li id="step-config" data-step="config">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Write configuration files</span>
                <span class="step-status"></span>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('config')">Retry</button>
        </li>
        <li id="step-token" data-step="token">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Create Proxmox API token</span>
                <span class="step-status"></span>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('token')">Retry</button>
        </li>
        <!-- terraform step runs in backend but hidden from UI - internal plumbing -->
        <li id="step-bridge" data-step="bridge">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Configure network bridge</span>
                <span class="step-status"></span>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('bridge')">Retry</button>
        </li>
        <li id="step-ipv6" data-step="ipv6">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Configure IPv6</span>
                <span class="step-status"></span>
                <div id="ipv6-data" class="hidden" style="margin-top: 0.5rem;">
                    <div class="contract-addr-row">
                        <span class="contract-addr-label">Prefix:</span>
                        <code id="ipv6-prefix" class="contract-addr"></code>
                        <button type="button" class="btn-copy" onclick="copyAddress('ipv6-prefix')" title="Copy">&#128203;</button>
                    </div>
                    <div class="contract-addr-row">
                        <span class="contract-addr-label">Mode:</span>
                        <code id="ipv6-mode" class="contract-addr"></code>
                    </div>
                </div>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('ipv6')">Retry</button>
        </li>
        <li id="step-https" data-step="https">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Configure HTTPS for signup</span>
                <span class="step-status"></span>
                <div id="https-data" class="hidden" style="margin-top: 0.5rem;">
                    <div class="contract-addr-row">
                        <span class="contract-addr-label">Hostname:</span>
                        <code id="https-hostname" class="contract-addr"></code>
                        <button type="button" class="btn-copy" onclick="copyAddress('https-hostname')" title="Copy">&#128203;</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('https')">Retry</button>
        </li>
        <li id="step-signup" data-step="signup">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Generate signup page</span>
                <span class="step-status"></span>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('signup')">Retry</button>
        </li>
        <li id="step-mint_nft" data-step="mint_nft">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Mint admin NFT</span>
                <span class="step-status"></span>
                <div id="mint-nft-data" class="hidden" style="margin-top: 0.5rem;">
                    <div class="contract-addr-row">
                        <span class="contract-addr-label">Token ID:</span>
                        <code id="mint-nft-token-id" class="contract-addr"></code>
                        <button type="button" class="btn-copy" onclick="copyAddress('mint-nft-token-id')" title="Copy">&#128203;</button>
                    </div>
                    <div class="contract-addr-row">
                        <span class="contract-addr-label">TX Hash:</span>
                        <code id="mint-nft-tx-hash" class="contract-addr"></code>
                        <button type="button" class="btn-copy" onclick="copyAddress('mint-nft-tx-hash')" title="Copy">&#128203;</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('mint_nft')">Retry</button>
        </li>
        <li id="step-template" data-step="template">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Build VM template</span>
                <span class="step-status"></span>
                <span class="step-hint">(this may take several minutes)</span>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('template')">Retry</button>
        </li>
        <li id="step-finalize" data-step="finalize">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Finalize setup</span>
                <span class="step-status"></span>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('finalize')">Retry</button>
        </li>
        <li id="step-validate" data-step="validate">
            <span class="step-icon">&#9675;</span>
            <div class="step-content">
                <span class="step-name">Validate system</span>
                <span class="step-status"></span>
                <span class="step-hint">(testing builds only)</span>
            </div>
            <button class="btn btn-small btn-retry hidden" onclick="retryStep('validate')">Retry</button>
        </li>
    </ul>

    <!-- Validation Output (testing mode only) -->
    <div id="validation-output-section" class="hidden" style="margin-top: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem;">Validation Results</h3>
        <pre id="validation-output" style="background: var(--bg-input); padding: 1rem; border-radius: 0.5rem; font-size: 0.75rem; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
    </div>

    <div id="completion-section" class="hidden" style="margin-top: 2rem;">
        <div class="alert alert-success">
            <strong>Setup Complete!</strong> BlockHost has been configured successfully.
        </div>
        <p class="text-muted" style="margin-top: 1rem;">
            The system is now operational. VMs will be provisioned automatically when users purchase subscriptions.
        </p>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button onclick="reboot()" class="btn btn-primary">Reboot System</button>
            <a href="https://{{ request.host.split(':')[0] }}:8006" class="btn btn-secondary">
                Open Proxmox
            </a>
        </div>
    </div>

    <div id="error-section" class="hidden" style="margin-top: 2rem;">
        <div class="alert alert-error">
            <strong>Step failed:</strong> <span id="error-step-name"></span>
            <p id="error-message" style="margin-top: 0.5rem; font-family: monospace; font-size: 0.85rem;"></p>
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="retryFailed()">Retry Failed Step</button>
            <button class="btn btn-secondary" onclick="resetAndRestart()">Start Over</button>
        </div>
    </div>

    <div id="resume-section" class="hidden" style="margin-top: 2rem;">
        <div class="alert alert-info">
            <strong>Previous setup incomplete.</strong> You can resume from where you left off.
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="resumeSetup()">Resume Setup</button>
            <button class="btn btn-secondary" onclick="resetAndRestart()">Start Over</button>
        </div>
    </div>
</div>

<!-- Completion Card -->
<div class="card hidden" id="completion-card" style="max-width: 600px; margin: 0 auto; text-align: center;">
    <h2 class="text-success">Setup Complete!</h2>
    <p class="text-muted mb-2">BlockHost has been configured successfully.</p>

    <div class="alert alert-success" style="margin: 2rem 0;">
        <strong>Important:</strong> The system is now operational. VMs will be provisioned automatically
        when users purchase subscriptions on the blockchain.
    </div>

    <div class="summary-section" style="text-align: left;">
        <h3>What's Next?</h3>
        <ul style="list-style: disc; padding-left: 1.5rem; color: var(--text-muted);">
            <li>Access Proxmox VE at <a href="https://{{ request.host.split(':')[0] }}:8006" style="color: var(--primary);">https://{{ request.host.split(':')[0] }}:8006</a></li>
            <li>The blockhost-engine is monitoring the blockchain for subscription events</li>
            <li>VMs will be created automatically when subscriptions are purchased</li>
            <li>Users connect to their VMs using NFT-based authentication</li>
        </ul>
    </div>

    <div style="margin-top: 2rem;">
        <button onclick="reboot()" class="btn btn-primary">Reboot System</button>
        <a href="https://{{ request.host.split(':')[0] }}:8006" class="btn btn-secondary" style="margin-left: 0.5rem;">
            Open Proxmox
        </a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.progress-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.progress-list li {
    display: flex;
    align-items: flex-start;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
    gap: 0.75rem;
}

.progress-list li:last-child {
    border-bottom: none;
}

.step-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1rem;
}

.step-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.step-name {
    font-weight: 500;
}

.step-status {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.step-hint {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-style: italic;
}

.progress-list li.completed .step-icon {
    color: var(--success);
}

.progress-list li.in-progress .step-icon {
    color: var(--primary);
}

.progress-list li.failed .step-icon {
    color: var(--danger);
}

.progress-list li.failed .step-status {
    color: var(--danger);
}

.btn-retry {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background: var(--warning);
    border-color: var(--warning);
}

.btn-retry:hover {
    background: #d97706;
}

.spinner-small {
    width: 16px;
    height: 16px;
    border: 2px solid var(--primary);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Contract address display */
.contract-addr-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.25rem;
}

.contract-addr-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    min-width: 5rem;
}

.contract-addr {
    font-size: 0.7rem;
    background: var(--bg-input);
    padding: 0.15rem 0.4rem;
    border-radius: 0.25rem;
    user-select: all;
}

.btn-copy {
    background: none;
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    padding: 0.1rem 0.35rem;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--text-muted);
    line-height: 1;
}

.btn-copy:hover {
    background: var(--bg-input);
    color: var(--text-primary);
}

.btn-copy.copied {
    color: var(--success);
    border-color: var(--success);
}

/* Validation output styling */
#validation-output {
    line-height: 1.4;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let pollInterval;
// Note: 'terraform' step runs in backend but is hidden from UI (internal plumbing)
const stepOrder = ['keypair', 'wallet', 'contracts', 'config', 'token', 'bridge', 'ipv6', 'https', 'signup', 'mint_nft', 'template', 'finalize', 'validate'];
const stepNames = {
    'keypair': 'Generate server keypair',
    'wallet': 'Configure deployer wallet',
    'contracts': 'Deploy smart contracts',
    'config': 'Write configuration files',
    'token': 'Create Proxmox API token',
    'bridge': 'Configure network bridge',
    'ipv6': 'Configure IPv6',
    'https': 'Configure HTTPS for signup',
    'signup': 'Generate signup page',
    'mint_nft': 'Mint admin NFT',
    'template': 'Build VM template',
    'finalize': 'Finalize setup',
    'validate': 'Validate system'
};

// Check for existing state on page load
document.addEventListener('DOMContentLoaded', function() {
    checkExistingState();
});

function checkExistingState() {
    fetch('/api/finalize/status')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'completed') {
            // Already complete, show progress card with completion
            showProgressCard();
            updateProgress(data);
            showCompletion();
        } else if (data.status === 'running') {
            // Currently running, show progress and poll
            showProgressCard();
            updateProgress(data);
            startPolling();
        } else if (data.status === 'failed') {
            // Failed, show progress with error
            showProgressCard();
            updateProgress(data);
            showError(data.failed_step, data.error);
        } else if (data.completed_steps && data.completed_steps.length > 0) {
            // Partially complete, offer to resume
            showProgressCard();
            updateProgress(data);
            document.getElementById('resume-section').classList.remove('hidden');
        }
        // Otherwise, show summary card (default)
    })
    .catch(error => {
        console.error('Error checking state:', error);
        // Show summary card on error
    });
}

// Handle form submission
document.getElementById('summary-form').addEventListener('submit', function(e) {
    if (e.submitter.value !== 'yes') return;

    e.preventDefault();
    startFinalization();
});

function showProgressCard() {
    document.getElementById('summary-card').classList.add('hidden');
    document.getElementById('progress-card').classList.remove('hidden');

    // Update contracts step text based on mode
    {% if not summary.blockchain.deploy_contracts %}
    document.getElementById('step-contracts-text').textContent = 'Verify contract addresses';
    {% endif %}
}

function startFinalization() {
    showProgressCard();

    // Start the finalization process
    fetch('/api/finalize', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running' || data.status === 'completed') {
            startPolling();
        } else if (data.error) {
            showError(null, data.error);
        }
    })
    .catch(error => {
        showError(null, error.message);
    });
}

function resumeSetup() {
    document.getElementById('resume-section').classList.add('hidden');
    document.getElementById('error-section').classList.add('hidden');

    fetch('/api/finalize/retry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running') {
            startPolling();
        } else if (data.error) {
            showError(null, data.error);
        }
    })
    .catch(error => {
        showError(null, error.message);
    });
}

function retryStep(stepId) {
    document.getElementById('error-section').classList.add('hidden');

    // Reset step UI
    const li = document.getElementById('step-' + stepId);
    li.classList.remove('failed');
    li.querySelector('.step-status').textContent = '';
    li.querySelector('.btn-retry').classList.add('hidden');

    fetch('/api/finalize/retry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({step_id: stepId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running') {
            startPolling();
        } else if (data.error) {
            showError(stepId, data.error);
        }
    })
    .catch(error => {
        showError(stepId, error.message);
    });
}

function retryFailed() {
    document.getElementById('error-section').classList.add('hidden');

    fetch('/api/finalize/retry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running') {
            startPolling();
        } else if (data.error) {
            showError(null, data.error);
        }
    })
    .catch(error => {
        showError(null, error.message);
    });
}

function resetAndRestart() {
    if (!confirm('This will reset all progress and start the configuration from the beginning. Continue?')) {
        return;
    }

    fetch('/api/finalize/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        // Reset UI
        stepOrder.forEach(step => {
            const li = document.getElementById('step-' + step);
            li.classList.remove('completed', 'in-progress', 'failed');
            li.querySelector('.step-icon').innerHTML = '&#9675;';
            li.querySelector('.step-status').textContent = '';
            li.querySelector('.btn-retry').classList.add('hidden');
        });

        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('progress-text').textContent = '0%';
        document.getElementById('error-section').classList.add('hidden');
        document.getElementById('resume-section').classList.add('hidden');

        // Start fresh
        startFinalization();
    })
    .catch(error => {
        alert('Error resetting state: ' + error.message);
    });
}

function startPolling() {
    stopPolling();
    pollInterval = setInterval(pollStatus, 2000);
    pollStatus(); // Immediate first poll
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

function pollStatus() {
    fetch('/api/finalize/status')
    .then(response => response.json())
    .then(data => {
        updateProgress(data);

        if (data.status === 'completed') {
            stopPolling();
            showCompletion();
        } else if (data.status === 'failed') {
            stopPolling();
            showError(data.failed_step, data.error);
        }
    })
    .catch(error => {
        console.error('Poll error:', error);
        // Don't stop polling on transient errors
    });
}

function updateProgress(data) {
    // Update progress bar
    const percent = data.progress || 0;
    document.getElementById('progress-fill').style.width = percent + '%';
    document.getElementById('progress-text').textContent = percent + '%';

    // Update step indicators
    const currentStep = data.current_step;
    const completedSteps = data.completed_steps || [];
    const steps = data.steps || {};

    stepOrder.forEach(stepId => {
        const li = document.getElementById('step-' + stepId);
        const icon = li.querySelector('.step-icon');
        const status = li.querySelector('.step-status');
        const retryBtn = li.querySelector('.btn-retry');
        const stepData = steps[stepId] || {};

        // Reset classes
        li.classList.remove('completed', 'in-progress', 'failed');
        retryBtn.classList.add('hidden');

        if (stepData.status === 'completed' || completedSteps.includes(stepId)) {
            li.classList.add('completed');
            icon.innerHTML = '&#10003;';
            status.textContent = stepData.completed_at ? 'Completed' : '';

            // Show step data when steps complete
            if (stepId === 'wallet' && stepData.data && stepData.data.deployer_address) {
                document.getElementById('wallet-deployer-addr').textContent = stepData.data.deployer_address;
                document.getElementById('wallet-data').classList.remove('hidden');
            }
            if (stepId === 'contracts' && stepData.data && stepData.data.contracts) {
                const addrs = document.getElementById('contract-addresses');
                document.getElementById('contract-nft-addr').textContent = stepData.data.contracts.nft || '';
                document.getElementById('contract-sub-addr').textContent = stepData.data.contracts.subscription || '';
                addrs.classList.remove('hidden');
            }
            if (stepId === 'ipv6' && stepData.data && stepData.data.prefix) {
                document.getElementById('ipv6-prefix').textContent = stepData.data.prefix;
                document.getElementById('ipv6-mode').textContent = stepData.data.mode || '';
                document.getElementById('ipv6-data').classList.remove('hidden');
            }
            if (stepId === 'https' && stepData.data && stepData.data.hostname) {
                document.getElementById('https-hostname').textContent = stepData.data.hostname;
                document.getElementById('https-data').classList.remove('hidden');
            }
            if (stepId === 'mint_nft' && stepData.data) {
                if (stepData.data.token_id) {
                    document.getElementById('mint-nft-token-id').textContent = stepData.data.token_id;
                }
                if (stepData.data.tx_hash) {
                    document.getElementById('mint-nft-tx-hash').textContent = stepData.data.tx_hash;
                }
                document.getElementById('mint-nft-data').classList.remove('hidden');
            }
        } else if (stepData.status === 'in_progress' || stepId === currentStep) {
            li.classList.add('in-progress');
            icon.innerHTML = '<div class="spinner-small"></div>';
            status.textContent = 'Running...';
        } else if (stepData.status === 'failed') {
            li.classList.add('failed');
            icon.innerHTML = '&#10007;';
            status.textContent = stepData.error || 'Failed';
            retryBtn.classList.remove('hidden');
        } else {
            icon.innerHTML = '&#9675;';
            status.textContent = '';
        }
    });
}

function showCompletion() {
    stopPolling();
    // Keep progress card visible, show completion section within it
    document.getElementById('completion-section').classList.remove('hidden');
    // Hide the progress bar since we're done
    document.getElementById('progress-bar').parentElement.style.display = 'none';
    document.getElementById('progress-text').style.display = 'none';
    // Update title
    document.querySelector('#progress-card h2').textContent = 'Setup Complete';
    document.querySelector('#progress-card p.text-muted').textContent = 'All steps completed successfully.';

    // Mark setup complete (redundant but ensures marker exists)
    fetch('/api/complete', {method: 'POST'});

    // Fetch and display validation output (testing mode only)
    fetchValidationOutput();
}

function fetchValidationOutput() {
    fetch('/api/validation-output')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.output) {
            const section = document.getElementById('validation-output-section');
            const pre = document.getElementById('validation-output');
            pre.textContent = data.output;
            section.classList.remove('hidden');
        }
    })
    .catch(error => {
        console.error('Error fetching validation output:', error);
    });
}

function showError(stepId, message) {
    const errorSection = document.getElementById('error-section');
    const errorStepName = document.getElementById('error-step-name');
    const errorMessage = document.getElementById('error-message');

    errorSection.classList.remove('hidden');
    errorStepName.textContent = stepId ? stepNames[stepId] : 'Unknown step';
    errorMessage.textContent = message || 'Unknown error occurred';

    // Show retry button on the failed step
    if (stepId) {
        const li = document.getElementById('step-' + stepId);
        if (li) {
            li.querySelector('.btn-retry').classList.remove('hidden');
        }
    }

    // If validation failed, show the detailed output
    if (stepId === 'validate') {
        fetchValidationOutput();
    }
}

function copyAddress(elementId) {
    const text = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById(elementId).nextElementSibling;
        btn.classList.add('copied');
        btn.innerHTML = '&#10003;';
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '&#128203;';
        }, 2000);
    }).catch(() => {
        // Fallback for Firefox on HTTP (clipboard API requires secure context)
        const range = document.createRange();
        range.selectNodeContents(document.getElementById(elementId));
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        try {
            document.execCommand('copy');
            const btn = document.getElementById(elementId).nextElementSibling;
            btn.classList.add('copied');
            btn.innerHTML = '&#10003;';
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '&#128203;';
            }, 2000);
        } catch(e) {
            // At least the text is selected for manual copy
        }
        sel.removeAllRanges();
    });
}

function reboot() {
    if (!confirm('This will reboot the system. Continue?')) {
        return;
    }

    fetch('/api/reboot', {method: 'POST'})
    .then(() => {
        alert('System is rebooting. You will need to reconnect after reboot completes.');
    })
    .catch(error => {
        alert('Reboot failed: ' + error.message);
    });
}
</script>
{% endblock %}
