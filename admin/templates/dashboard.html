{% extends "base.html" %}

{% block title %}Dashboard - BlockHost Admin{% endblock %}

{% block content %}
<div id="global-alert" class="alert"></div>

<!-- System -->
<div class="card" id="system">
    <div class="card-header" onclick="toggleCard(this)">
        <h2><span class="section-icon">&#9881;</span> System</h2>
        <span class="card-arrow">&#9660;</span>
    </div>
    <div class="card-body">
        <div class="kv-row">
            <span class="kv-label">Hostname</span>
            <span class="kv-value">
                <span class="form-inline-edit">
                    <input type="text" id="hostname-input" size="20" placeholder="hostname">
                    <button class="btn btn-sm btn-primary" onclick="setHostname()">Save</button>
                </span>
            </span>
        </div>
        <div class="kv-row">
            <span class="kv-label">Uptime</span>
            <span class="kv-value" id="sys-uptime">-</span>
        </div>
        <div class="kv-row">
            <span class="kv-label">OS</span>
            <span class="kv-value" id="sys-os">-</span>
        </div>
        <div class="kv-row">
            <span class="kv-label">Kernel</span>
            <span class="kv-value" id="sys-kernel">-</span>
        </div>
    </div>
</div>

<!-- Storage -->
<div class="card" id="storage">
    <div class="card-header" onclick="toggleCard(this)">
        <h2><span class="section-icon">&#9744;</span> Storage</h2>
        <span class="card-arrow">&#9660;</span>
    </div>
    <div class="card-body">
        <div id="storage-usage"></div>
        <h3 style="font-size: 0.875rem; color: var(--text-muted); margin: 1.25rem 0 0.75rem; text-transform: uppercase; letter-spacing: 0.03em;">Block Devices</h3>
        <div id="storage-devices">
            <div class="placeholder-msg"><span class="spinner-sm"></span> Loading...</div>
        </div>
    </div>
</div>

<!-- Security -->
<div class="card" id="security">
    <div class="card-header" onclick="toggleCard(this)">
        <h2><span class="section-icon">&#9919;</span> Security</h2>
        <span class="card-arrow">&#9660;</span>
    </div>
    <div class="card-body">
        <div class="kv-row">
            <span class="kv-label">Admin Commands</span>
            <span class="kv-value" id="sec-enabled">-</span>
        </div>
        <div class="kv-row">
            <span class="kv-label">Knock Command</span>
            <span class="kv-value">
                <span class="form-inline-edit">
                    <input type="text" id="sec-knock-command" size="20">
                </span>
            </span>
        </div>
        <div class="kv-row">
            <span class="kv-label">Knock Ports</span>
            <span class="kv-value">
                <span class="form-inline-edit">
                    <input type="text" id="sec-knock-ports" size="30" placeholder="e.g. 7000,8000,9000">
                </span>
            </span>
        </div>
        <div class="kv-row">
            <span class="kv-label">Knock Timeout</span>
            <span class="kv-value">
                <span class="form-inline-edit">
                    <input type="number" id="sec-knock-timeout" size="6" min="1">
                </span>
            </span>
        </div>
        <div style="margin-top: 1rem; text-align: right;">
            <button class="btn btn-primary" onclick="saveSecuritySettings()">Save Security Settings</button>
        </div>
    </div>
</div>

<!-- Network -->
<div class="card" id="network">
    <div class="card-header" onclick="toggleCard(this)">
        <h2><span class="section-icon">&#9729;</span> Network</h2>
        <span class="card-arrow">&#9660;</span>
    </div>
    <div class="card-body">
        <div class="kv-row">
            <span class="kv-label">IPv4 Address</span>
            <span class="kv-value" id="net-ipv4">-</span>
        </div>
        <div class="kv-row">
            <span class="kv-label">Gateway</span>
            <span class="kv-value" id="net-gateway">-</span>
        </div>
        <div class="kv-row">
            <span class="kv-label">DNS</span>
            <span class="kv-value" id="net-dns">-</span>
        </div>
        <div class="kv-row">
            <span class="kv-label">IPv6 Broker</span>
            <span class="kv-value" id="net-broker">-</span>
        </div>
        <div class="kv-row">
            <span class="kv-label">Broker Lease</span>
            <span class="kv-value">
                <button class="btn btn-sm btn-secondary" onclick="renewBrokerLease(this)">Re-request Lease</button>
            </span>
        </div>
    </div>
</div>

<!-- Wallet -->
<div class="card" id="wallet">
    <div class="card-header" onclick="toggleCard(this)">
        <h2><span class="section-icon">&#9878;</span> Wallet</h2>
        <span class="card-arrow">&#9660;</span>
    </div>
    <div class="card-body">
        <!-- Balances -->
        <h3 style="font-size: 0.875rem; color: var(--text-muted); margin: 0 0 0.75rem; text-transform: uppercase; letter-spacing: 0.03em;">Balances</h3>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
            <select id="wallet-role-select"></select>
            <button class="btn btn-sm btn-primary" onclick="loadBalance()">Check Balance</button>
        </div>
        <pre id="wallet-balance-output" style="background: var(--bg); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.75rem; font-size: 0.8125rem; overflow-x: auto; white-space: pre-wrap; color: var(--text-muted);">Select a wallet and click Check Balance</pre>

        <!-- Transfer -->
        <h3 style="font-size: 0.875rem; color: var(--text-muted); margin: 1.25rem 0 0.75rem; text-transform: uppercase; letter-spacing: 0.03em;">Transfer</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end;">
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">From</label>
                <select id="send-from"></select>
            </div>
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Amount</label>
                <input type="text" id="send-amount" size="12" placeholder="0.01" style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.375rem 0.625rem; color: var(--text); font-family: monospace; font-size: 0.875rem;">
            </div>
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Token</label>
                <select id="send-token" onchange="toggleCustomToken()">
                    <option value="eth">ETH</option>
                    <option value="stable">Stablecoin</option>
                    <option value="custom">Custom...</option>
                </select>
            </div>
            <div id="send-token-custom-wrap" style="display: none;">
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Contract</label>
                <input type="text" id="send-token-custom" size="30" placeholder="0x..." style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.375rem 0.625rem; color: var(--text); font-family: monospace; font-size: 0.875rem;">
            </div>
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">To</label>
                <select id="send-to" onchange="toggleCustomTo('send')">
                </select>
            </div>
            <div id="send-to-custom-wrap" style="display: none;">
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Address</label>
                <input type="text" id="send-to-custom" size="30" placeholder="0x..." style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.375rem 0.625rem; color: var(--text); font-family: monospace; font-size: 0.875rem;">
            </div>
            <button class="btn btn-sm btn-primary" onclick="walletSend(this)">Send</button>
        </div>

        <!-- Withdraw -->
        <h3 style="font-size: 0.875rem; color: var(--text-muted); margin: 1.25rem 0 0.75rem; text-transform: uppercase; letter-spacing: 0.03em;">Contract Withdraw</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end;">
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Token</label>
                <select id="withdraw-token" onchange="toggleCustomWithdrawToken()">
                    <option value="">All</option>
                    <option value="eth">ETH</option>
                    <option value="stable">Stablecoin</option>
                    <option value="custom">Custom...</option>
                </select>
            </div>
            <div id="withdraw-token-custom-wrap" style="display: none;">
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Contract</label>
                <input type="text" id="withdraw-token-custom" size="30" placeholder="0x..." style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.375rem 0.625rem; color: var(--text); font-family: monospace; font-size: 0.875rem;">
            </div>
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">To</label>
                <select id="withdraw-to" onchange="toggleCustomTo('withdraw')">
                </select>
            </div>
            <div id="withdraw-to-custom-wrap" style="display: none;">
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Address</label>
                <input type="text" id="withdraw-to-custom" size="30" placeholder="0x..." style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.375rem 0.625rem; color: var(--text); font-family: monospace; font-size: 0.875rem;">
            </div>
            <button class="btn btn-sm btn-primary" onclick="walletWithdraw(this)">Withdraw</button>
        </div>

        <!-- Transaction output -->
        <pre id="wallet-tx-output" style="display: none; background: var(--bg); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.75rem; font-size: 0.8125rem; overflow-x: auto; white-space: pre-wrap; margin-top: 1rem;"></pre>
    </div>
</div>

<!-- Addressbook -->
<div class="card" id="addressbook">
    <div class="card-header" onclick="toggleCard(this)">
        <h2><span class="section-icon">&#9993;</span> Addressbook</h2>
        <span class="card-arrow">&#9660;</span>
    </div>
    <div class="card-body">
        <div id="addressbook-table">
            <div class="placeholder-msg"><span class="spinner-sm"></span> Loading...</div>
        </div>

        <!-- Add -->
        <h3 style="font-size: 0.875rem; color: var(--text-muted); margin: 1.25rem 0 0.75rem; text-transform: uppercase; letter-spacing: 0.03em;">Add Entry</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end;">
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Name</label>
                <input type="text" id="ab-add-name" size="15" maxlength="20" placeholder="mywalletname" style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.375rem 0.625rem; color: var(--text); font-family: monospace; font-size: 0.875rem;">
            </div>
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Address</label>
                <input type="text" id="ab-add-address" size="30" placeholder="0x..." style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.375rem 0.625rem; color: var(--text); font-family: monospace; font-size: 0.875rem;">
            </div>
            <button class="btn btn-sm btn-primary" onclick="addressbookAdd(this)">Add</button>
        </div>

        <!-- Generate -->
        <h3 style="font-size: 0.875rem; color: var(--text-muted); margin: 1.25rem 0 0.75rem; text-transform: uppercase; letter-spacing: 0.03em;">Generate New Wallet</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end;">
            <div>
                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Name</label>
                <input type="text" id="ab-gen-name" size="15" maxlength="20" placeholder="mywalletname" style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.375rem 0.625rem; color: var(--text); font-family: monospace; font-size: 0.875rem;">
            </div>
            <button class="btn btn-sm btn-primary" onclick="addressbookGenerate(this)">Generate</button>
        </div>

        <!-- Output -->
        <pre id="ab-output" style="display: none; background: var(--bg); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.75rem; font-size: 0.8125rem; overflow-x: auto; white-space: pre-wrap; margin-top: 1rem;"></pre>
    </div>
</div>

<!-- VMs -->
<div class="card" id="vms">
    <div class="card-header" onclick="toggleCard(this)">
        <h2><span class="section-icon">&#9654;</span> Virtual Machines</h2>
        <span class="card-arrow">&#9660;</span>
    </div>
    <div class="card-body">
        <div id="vm-table">
            <div class="placeholder-msg"><span class="spinner-sm"></span> Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// --- Utilities ---

async function apiGet(url) {
    const r = await fetch(url);
    return r.json();
}

async function apiPost(url, body) {
    const r = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: body ? JSON.stringify(body) : undefined,
    });
    return r.json();
}

function showAlert(msg, type) {
    const el = document.getElementById('global-alert');
    el.textContent = msg;
    el.className = 'alert alert-' + type + ' visible';
    setTimeout(() => el.classList.remove('visible'), 4000);
}

function formatUptime(seconds) {
    if (seconds == null) return '-';
    const d = Math.floor(seconds / 86400);
    const h = Math.floor((seconds % 86400) / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const parts = [];
    if (d > 0) parts.push(d + 'd');
    if (h > 0) parts.push(h + 'h');
    parts.push(m + 'm');
    return parts.join(' ');
}

function formatBytes(bytes) {
    if (bytes == null) return '-';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let i = 0;
    let v = bytes;
    while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
    return v.toFixed(1) + ' ' + units[i];
}

function toggleCard(header) {
    header.closest('.card').classList.toggle('collapsed');
}

// --- Section loaders ---

async function loadSystem() {
    try {
        const data = await apiGet('/api/system');
        document.getElementById('hostname-input').value = data.hostname || '';
        document.getElementById('sys-uptime').textContent = formatUptime(data.uptime_seconds);
        document.getElementById('sys-os').textContent = data.os || '-';
        document.getElementById('sys-kernel').textContent = data.kernel || '-';
        document.getElementById('status-text').textContent = data.hostname || 'Unknown';
        document.getElementById('status-dot').style.background = 'var(--success)';
    } catch (e) {
        document.getElementById('status-dot').style.background = 'var(--error)';
        document.getElementById('status-text').textContent = 'Error';
    }
}

async function loadNetwork() {
    try {
        const data = await apiGet('/api/network');
        document.getElementById('net-ipv4').textContent = data.ipv4 || 'Not available';
        document.getElementById('net-gateway').textContent = data.gateway || 'Not available';
        document.getElementById('net-dns').textContent = data.dns && data.dns.length ? data.dns.join(', ') : 'None';

        const broker = data.ipv6_broker;
        if (broker && typeof broker === 'object') {
            const prefix = broker.prefix || broker.ipv6_prefix || '';
            const status = broker.status || 'allocated';
            document.getElementById('net-broker').innerHTML =
                '<span class="badge badge-active">' + status + '</span> ' + prefix;
        } else {
            document.getElementById('net-broker').textContent = 'Not configured';
        }
    } catch (e) {
        // Leave defaults
    }
}

async function loadSecurity() {
    try {
        const data = await apiGet('/api/security');
        if (data.ok === false) {
            document.getElementById('sec-enabled').textContent = 'Config not found';
            return;
        }
        document.getElementById('sec-enabled').innerHTML = data.enabled
            ? '<span class="badge badge-active">Enabled</span>'
            : '<span class="badge badge-destroyed">Disabled</span>';
        document.getElementById('sec-knock-command').value = data.knock_command || '';
        const ports = data.knock_ports;
        document.getElementById('sec-knock-ports').value = Array.isArray(ports) ? ports.join(', ') : (ports || '');
        document.getElementById('sec-knock-timeout').value = data.knock_timeout || '';
    } catch (e) {
        document.getElementById('sec-enabled').textContent = 'Error loading';
    }
}

async function loadStorage() {
    try {
        const data = await apiGet('/api/storage');

        // Usage bars
        const usageEl = document.getElementById('storage-usage');
        usageEl.innerHTML = '';
        if (data.usage && data.usage.length) {
            data.usage.forEach(u => {
                const pct = ((u.used / u.total) * 100).toFixed(1);
                const cls = pct > 90 ? 'crit' : pct > 75 ? 'warn' : '';
                usageEl.innerHTML += `
                    <div class="kv-row">
                        <span class="kv-label" style="min-width: 5rem; flex-shrink: 0;">${u.mount}</span>
                        <span class="kv-value" style="flex: 1; margin-left: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div class="progress-bar" style="flex: 1;">
                                    <div class="progress-fill ${cls}" style="width: ${pct}%;"></div>
                                </div>
                                <span style="min-width: 7rem; text-align: right; font-size: 0.8125rem;">
                                    ${formatBytes(u.used)} / ${formatBytes(u.total)}
                                </span>
                            </div>
                        </span>
                    </div>`;
            });
        }

        // Block devices
        const devEl = document.getElementById('storage-devices');
        if (!data.devices || data.devices.length === 0) {
            devEl.innerHTML = '<div class="placeholder-msg">No block devices found</div>';
            return;
        }

        let html = '<table><thead><tr><th>Name</th><th>Size</th><th>Type</th><th>Mount</th><th>Note</th></tr></thead><tbody>';
        function renderDev(dev, indent) {
            const isBoot = dev.name === data.boot_device;
            const prefix = indent > 0 ? '&nbsp;'.repeat(indent * 2) + '&#9492; ' : '';
            const note = isBoot ? '<span class="badge badge-suspended">boot</span>' : '';
            const mount = dev.mountpoint || dev.mountpoints?.filter(m => m).join(', ') || '';
            html += `<tr>
                <td>${prefix}${dev.name}</td>
                <td>${dev.size || '-'}</td>
                <td>${dev.type || '-'}</td>
                <td style="font-family: monospace;">${mount}</td>
                <td>${note}</td>
            </tr>`;
            if (dev.children) {
                dev.children.forEach(c => renderDev(c, indent + 1));
            }
        }
        data.devices.forEach(d => renderDev(d, 0));
        html += '</tbody></table>';
        devEl.innerHTML = html;
    } catch (e) {
        document.getElementById('storage-devices').innerHTML = '<div class="placeholder-msg">Error loading storage info</div>';
    }
}

async function loadVMs() {
    try {
        const data = await apiGet('/api/vms');
        const el = document.getElementById('vm-table');

        if (!Array.isArray(data) || data.length === 0) {
            el.innerHTML = '<div class="placeholder-msg">No virtual machines found</div>';
            return;
        }

        let html = '<table><thead><tr><th>Name</th><th>Status</th><th>IP</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
        data.forEach(vm => {
            const statusClass = 'badge-' + (vm.status || 'unknown');
            const isActive = vm.status === 'active';
            const isSuspended = vm.status === 'suspended';
            html += `<tr>
                <td style="font-weight: 500;">${vm.name}</td>
                <td><span class="badge ${statusClass}">${vm.status || 'unknown'}</span></td>
                <td style="font-family: monospace;">${vm.ip || '-'}</td>
                <td>${vm.created || '-'}</td>
                <td>
                    <div class="btn-group">
                        ${isSuspended ? `<button class="btn btn-sm btn-success" onclick="vmAction('${vm.name}', 'start', this)">Start</button>` : ''}
                        ${isActive ? `<button class="btn btn-sm btn-warning" onclick="vmAction('${vm.name}', 'stop', this)">Stop</button>` : ''}
                        ${isActive ? `<button class="btn btn-sm btn-secondary" onclick="vmAction('${vm.name}', 'kill', this)">Kill</button>` : ''}
                        <button class="btn btn-sm btn-danger" onclick="confirmDestroy('${vm.name}', this)">Destroy</button>
                    </div>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        el.innerHTML = html;
    } catch (e) {
        document.getElementById('vm-table').innerHTML = '<div class="placeholder-msg">Error loading VMs</div>';
    }
}

// --- Wallet ---

let walletData = [];

async function loadWallet() {
    try {
        const data = await apiGet('/api/wallet');
        if (Array.isArray(data)) {
            walletData = data;
            populateWalletSelects();
        }
    } catch (e) {
        // Leave defaults
    }
}

function populateWalletSelects() {
    // Balance role select: all wallets
    const roleSelect = document.getElementById('wallet-role-select');
    roleSelect.innerHTML = '';
    walletData.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w.role;
        opt.textContent = w.role + ' (' + w.address.slice(0, 6) + '...' + w.address.slice(-4) + ')';
        roleSelect.appendChild(opt);
    });

    // From select: only can_sign wallets
    const fromSelect = document.getElementById('send-from');
    fromSelect.innerHTML = '';
    walletData.filter(w => w.can_sign).forEach(w => {
        const opt = document.createElement('option');
        opt.value = w.role;
        opt.textContent = w.role;
        fromSelect.appendChild(opt);
    });

    // To selects: all wallets + Custom
    ['send-to', 'withdraw-to'].forEach(id => {
        const sel = document.getElementById(id);
        sel.innerHTML = '';
        walletData.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w.role;
            opt.textContent = w.role + ' (' + w.address.slice(0, 6) + '...' + w.address.slice(-4) + ')';
            sel.appendChild(opt);
        });
        const customOpt = document.createElement('option');
        customOpt.value = 'custom';
        customOpt.textContent = 'Custom address...';
        sel.appendChild(customOpt);
    });
}

async function loadBalance() {
    const role = document.getElementById('wallet-role-select').value;
    if (!role) return;
    const el = document.getElementById('wallet-balance-output');
    el.textContent = 'Loading...';
    try {
        const res = await apiGet('/api/wallet/balance/' + encodeURIComponent(role));
        el.textContent = res.ok ? res.output : ('Error: ' + res.error);
    } catch (e) {
        el.textContent = 'Error: request failed';
    }
}

function toggleCustomToken() {
    const v = document.getElementById('send-token').value;
    document.getElementById('send-token-custom-wrap').style.display = v === 'custom' ? '' : 'none';
}

function toggleCustomWithdrawToken() {
    const v = document.getElementById('withdraw-token').value;
    document.getElementById('withdraw-token-custom-wrap').style.display = v === 'custom' ? '' : 'none';
}

function toggleCustomTo(prefix) {
    const v = document.getElementById(prefix + '-to').value;
    document.getElementById(prefix + '-to-custom-wrap').style.display = v === 'custom' ? '' : 'none';
}

function resolveToken(selectId, customId) {
    const v = document.getElementById(selectId).value;
    if (v === 'custom') return document.getElementById(customId).value.trim();
    return v;
}

function resolveTo(selectId, customId) {
    const v = document.getElementById(selectId).value;
    if (v === 'custom') return document.getElementById(customId).value.trim();
    return v;
}

function showTxOutput(text, isError) {
    const el = document.getElementById('wallet-tx-output');
    el.textContent = text;
    el.style.display = 'block';
    el.style.color = isError ? 'var(--error)' : 'var(--success)';
}

async function walletSend(btn) {
    const from = document.getElementById('send-from').value;
    const amount = document.getElementById('send-amount').value.trim();
    const token = resolveToken('send-token', 'send-token-custom');
    const to = resolveTo('send-to', 'send-to-custom');

    if (!amount || !token || !to) {
        showTxOutput('All fields are required', true);
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span>';
    try {
        const res = await apiPost('/api/wallet/send', {amount, token, from, to});
        if (res.ok) {
            showTxOutput(res.output || 'Transfer successful', false);
        } else {
            showTxOutput('Error: ' + (res.error || 'unknown'), true);
        }
    } catch (e) {
        showTxOutput('Error: request failed', true);
    }
    btn.disabled = false;
    btn.textContent = 'Send';
}

async function walletWithdraw(btn) {
    const tokenVal = document.getElementById('withdraw-token').value;
    let token = null;
    if (tokenVal === 'custom') {
        token = document.getElementById('withdraw-token-custom').value.trim();
    } else if (tokenVal) {
        token = tokenVal;
    }
    const to = resolveTo('withdraw-to', 'withdraw-to-custom');

    if (!to) {
        showTxOutput('Destination is required', true);
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span>';
    try {
        const res = await apiPost('/api/wallet/withdraw', {to, token});
        if (res.ok) {
            showTxOutput(res.output || 'Withdrawal successful', false);
        } else {
            showTxOutput('Error: ' + (res.error || 'unknown'), true);
        }
    } catch (e) {
        showTxOutput('Error: request failed', true);
    }
    btn.disabled = false;
    btn.textContent = 'Withdraw';
}

// --- Addressbook ---

const RESERVED_ROLES = new Set(['server', 'admin', 'hot', 'dev', 'broker']);

async function loadAddressbook() {
    try {
        const data = await apiGet('/api/wallet');
        const el = document.getElementById('addressbook-table');
        if (!Array.isArray(data) || data.length === 0) {
            el.innerHTML = '<div class="placeholder-msg">No entries found</div>';
            return;
        }
        let html = '<table><thead><tr><th>Name</th><th>Address</th><th>Signing</th><th></th></tr></thead><tbody>';
        data.forEach(w => {
            const sigBadge = w.can_sign
                ? '<span class="badge badge-active">key</span>'
                : '';
            const removeBtn = RESERVED_ROLES.has(w.role)
                ? ''
                : `<button class="btn btn-sm btn-danger" onclick="addressbookRemove('${w.role}', this)">Remove</button>`;
            html += `<tr>
                <td style="font-weight: 500;">${w.role}</td>
                <td style="font-family: monospace; font-size: 0.8125rem;">${w.address}</td>
                <td>${sigBadge}</td>
                <td>${removeBtn}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        el.innerHTML = html;
    } catch (e) {
        document.getElementById('addressbook-table').innerHTML = '<div class="placeholder-msg">Error loading addressbook</div>';
    }
}

function showAbOutput(text, isError) {
    const el = document.getElementById('ab-output');
    el.textContent = text;
    el.style.display = 'block';
    el.style.color = isError ? 'var(--error)' : 'var(--success)';
}

async function addressbookAdd(btn) {
    const name = document.getElementById('ab-add-name').value.trim();
    const address = document.getElementById('ab-add-address').value.trim();
    if (!name || !address) {
        showAbOutput('Name and address are required', true);
        return;
    }
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span>';
    try {
        const res = await apiPost('/api/addressbook/add', {name, address});
        if (res.ok) {
            showAbOutput(res.output || 'Entry added', false);
            document.getElementById('ab-add-name').value = '';
            document.getElementById('ab-add-address').value = '';
            loadAddressbook();
            loadWallet();
        } else {
            showAbOutput('Error: ' + (res.error || 'unknown'), true);
        }
    } catch (e) {
        showAbOutput('Error: request failed', true);
    }
    btn.disabled = false;
    btn.textContent = 'Add';
}

async function addressbookRemove(name, btn) {
    if (!confirm(`Remove "${name}" from addressbook?`)) return;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span>';
    try {
        const res = await apiPost('/api/addressbook/remove', {name});
        if (res.ok) {
            showAbOutput(res.output || 'Entry removed', false);
            loadAddressbook();
            loadWallet();
        } else {
            showAbOutput('Error: ' + (res.error || 'unknown'), true);
        }
    } catch (e) {
        showAbOutput('Error: request failed', true);
    }
    btn.disabled = false;
    btn.textContent = 'Remove';
}

async function addressbookGenerate(btn) {
    const name = document.getElementById('ab-gen-name').value.trim();
    if (!name) {
        showAbOutput('Name is required', true);
        return;
    }
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span>';
    try {
        const res = await apiPost('/api/addressbook/generate', {name});
        if (res.ok) {
            showAbOutput(res.output || 'Wallet generated', false);
            document.getElementById('ab-gen-name').value = '';
            loadAddressbook();
            loadWallet();
        } else {
            showAbOutput('Error: ' + (res.error || 'unknown'), true);
        }
    } catch (e) {
        showAbOutput('Error: request failed', true);
    }
    btn.disabled = false;
    btn.textContent = 'Generate';
}

// --- Actions ---

async function setHostname() {
    const name = document.getElementById('hostname-input').value.trim();
    if (!name) return;
    const res = await apiPost('/api/system/hostname', {hostname: name});
    if (res.ok) {
        showAlert('Hostname updated to ' + name, 'success');
        loadSystem();
    } else {
        showAlert('Failed: ' + (res.error || 'unknown error'), 'error');
    }
}

async function renewBrokerLease(btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-sm"></span> Requesting...';
    const res = await apiPost('/api/network/broker/renew');
    if (res.ok) {
        showAlert('Broker lease renewed', 'success');
        loadNetwork();
    } else {
        showAlert('Lease renewal failed: ' + (res.error || 'unknown error'), 'error');
    }
    btn.disabled = false;
    btn.textContent = 'Re-request Lease';
}

async function saveSecuritySettings() {
    const portsRaw = document.getElementById('sec-knock-ports').value;
    let ports = portsRaw;
    // Parse comma-separated to array of ints if possible
    if (portsRaw.includes(',')) {
        ports = portsRaw.split(',').map(p => parseInt(p.trim(), 10)).filter(n => !isNaN(n));
    }

    const body = {
        knock_command: document.getElementById('sec-knock-command').value,
        knock_ports: ports,
        knock_timeout: parseInt(document.getElementById('sec-knock-timeout').value, 10) || undefined,
    };

    const res = await apiPost('/api/security', body);
    if (res.ok) {
        showAlert('Security settings saved', 'success');
    } else {
        showAlert('Failed: ' + (res.error || 'unknown error'), 'error');
    }
}

async function vmAction(name, action, btn) {
    btn.disabled = true;
    const origText = btn.textContent;
    btn.innerHTML = '<span class="spinner-sm"></span>';
    const res = await apiPost(`/api/vms/${name}/${action}`);
    if (res.ok) {
        showAlert(`${action} on ${name}: success`, 'success');
        setTimeout(loadVMs, 1000);
    } else {
        showAlert(`${action} on ${name} failed: ${res.error || 'unknown'}`, 'error');
        btn.disabled = false;
        btn.textContent = origText;
    }
}

function confirmDestroy(name, btn) {
    if (confirm(`Destroy VM "${name}"? This cannot be undone.`)) {
        vmAction(name, 'destroy', btn);
    }
}

// --- Init ---

document.addEventListener('DOMContentLoaded', () => {
    loadSystem();
    loadNetwork();
    loadSecurity();
    loadStorage();
    loadWallet();
    loadAddressbook();
    loadVMs();
});
</script>
{% endblock %}
